# skip_on_cran()
# skip_if(!interactive(),
#         message = "standardizedSolution_boot_ci not tested if not interactive")

library(testthat)
library(semhelpinghands)
set.seed(838914)
n <- 500
mod_pop <-
"
y1 ~ .2*x1 + .3*x2 + .1*x3
y2 ~ .2*x1 + .2*x3
y3 ~ .2*y2 + .2*x2
"
library(lavaan)
dat <- simulateData(model = mod_pop, sample.nobs = n)
dat$gp <- sample(c("gp1", "gp2"), n, replace = TRUE)
mod1 <-
"
y1 ~ x1 + x2 + x3
y2 ~ x1 + x3
y3 ~ y2 + x2
"
fit1 <- sem(mod1, dat, group = "gp")
est1 <- parameterEstimates(fit1)
std1 <- standardizedSolution(fit1)

mod2 <-
"
y1 ~ x1 + x2 + x3
y2 ~ x3
"
fit2 <- sem(mod2, dat, group = "gp")
est2 <- parameterEstimates(fit2)
std2 <- standardizedSolution(fit2)

fit1_nogroup <- sem(mod1, dat)
fit2_nogroup <- sem(mod2, dat)
est1_nogroup <- parameterEstimates(fit1_nogroup)
std1_nogroup <- standardizedSolution(fit1_nogroup)
est2_nogroup <- parameterEstimates(fit2_nogroup)
std2_nogroup <- standardizedSolution(fit2_nogroup)

out1 <- group_by_models(list(model1 = fit1,
                                  model2 = fit2),
                             standardized = TRUE,
                             col_names = c("std.all", "se"))
out1est <- group_by_models(list(model1 = fit1,
                                  model2 = fit2),
                             col_names = c("est", "se"))
out1est_est <- group_by_models(list(model1 = est1,
                                  model2 = est2),
                             col_names = c("est", "se"))
out1_std <- group_by_models(list(model1 = std1,
                                  model2 = std1),
                             col_names = c("est.std", "se"))

out1est_names <- paste0(out1$lhs, out1$op, out1$rhs, ".", out1$group)
out1est_std_names <- paste0(out1_std$lhs, out1_std$op, out1_std$rhs, ".", out1_std$group)
common_names <- intersect(out1est_names, out1est_std_names)

#head(dplyr::filter(out1, op == "~"))

out2 <- group_by_models(list(model1 = fit1_nogroup,
                                   model2 = fit2_nogroup),
                             standardized = TRUE,
                             col_names = c("std.all", "se"))
#head(dplyr::filter(out2, op == "~"))

out3 <- group_by_models(list(model1 = fit1,
                                  model2 = fit2),
                             standardized = TRUE,
                             col_names = c("std.all", "se"),
                             group_first = TRUE)
#head(dplyr::filter(out3, op == "~"))
#tail(dplyr::filter(out3, op == "~"))

out1_ans <- structure(list(lhs = c("x1", "x1", "x1", "x1", "x1", "x1", "x1",
"x1", "x2", "x2", "x2", "x2", "x2", "x2", "x3", "x3", "x3", "x3",
"y1", "y1", "y1", "y1", "y1", "y1", "y1", "y1", "y1", "y1", "y1",
"y1", "y1", "y1", "y2", "y2", "y2", "y2", "y2", "y2", "y2", "y2",
"y3", "y3", "y3", "y3", "y3", "y3", "y3", "y3"), op = c("~~",
"~~", "~~", "~~", "~~", "~~", "~1", "~1", "~~", "~~", "~~", "~~",
"~1", "~1", "~~", "~~", "~1", "~1", "~", "~", "~", "~", "~",
"~", "~~", "~~", "~~", "~~", "~~", "~~", "~1", "~1", "~", "~",
"~", "~", "~~", "~~", "~1", "~1", "~", "~", "~", "~", "~~", "~~",
"~1", "~1"), rhs = c("x1", "x1", "x2", "x2", "x3", "x3", "",
"", "x2", "x2", "x3", "x3", "", "", "x3", "x3", "", "", "x1",
"x1", "x2", "x2", "x3", "x3", "y1", "y1", "y2", "y2", "y3", "y3",
"", "", "x1", "x1", "x3", "x3", "y2", "y2", "", "", "x2", "x2",
"y2", "y2", "y3", "y3", "", ""), group = c(1L, 2L, 1L, 2L, 1L,
2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L,
2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L,
2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L, 1L, 2L), std.all_model1 = c(1,
1, -0.0286771526679605, 0.137522361597239, -0.0581722166132858,
-0.154925828907883, 0.00862364637919955, -0.039559417557601,
1, 1, 0.0198176588104157, 0.0118189225118024, 0.0693368324094334,
0.0121959864980669, 1, 1, 0.096384217898341, 0.0789029027439272,
0.230492922043281, 0.131743104564718, 0.22971760322925, 0.281669517496872,
0.0365081047042141, 0.143563375935194, 0.896453424198396, 0.877393751228805,
NA, NA, 0.0619941459427536, 0.013141235016658, -0.003305548661855,
0.0373109621067823, 0.180210836596298, 0.170598540011481, 0.123732579461709,
0.164386659122635, 0.954808545700896, 0.952562682775377, -0.025113096993796,
0.0591907856082862, 0.175874483409397, 0.124226195889164, 0.126720664275303,
0.178283504870627, 0.953131094972272, 0.951657575463657, 0.0509135539766324,
-0.0156340962169415), std.all_model2 = c(1, 1, -0.0286771526679605,
0.137522361597239, -0.0581722166132858, -0.154925828907883, 0.00862364637919955,
-0.039559417557601, 1, 1, 0.0198176588104157, 0.0118189225118024,
0.0693368324094334, 0.0121959864980669, 1, 1, 0.096384217898341,
0.0789029027439272, 0.22902200957256, 0.131555004152025, 0.230964781766562,
0.281700204687996, 0.0366989610879774, 0.143371071377257, 0.896533093586447,
0.877479600589609, -0.031053516708846, -0.000402491194641735,
NA, NA, -0.00339674162590084, 0.0373206393725567, NA, NA, 0.113249175701435,
0.137956716206957, 0.987174624202946, 0.980967944453393, -0.0225484249101459,
0.0545274245502585, NA, NA, NA, NA, NA, NA, NA, NA), se_model1 = c(0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0610241167164606,
0.0652527419284262, 0.0637983036178297, 0.0635495488518365, 0.0689887873389489,
0.0655840745092829, 0.0901288945902144, 0.0932030419008193, NA,
NA, 0.0675160533067203, 0.0617721656583714, 0.0645212422274359,
0.0642237709911687, 0.0620995150697461, 0.0601565242221361, 0.0702219414390783,
0.0610377044710866, 0.0930570983450699, 0.080808044516427, 0.0654130913523689,
0.0597940141819917, 0.0674196095926791, 0.0589791519949433, 0.0653785207427726,
0.0610561370589951, 0.100766026264319, 0.0818673195136828, 0.067914883927668,
0.0601068338669732), se_model2 = c(0, 0, 0, 0, 0, 0, 0, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0.061107866578356, 0.0652582106369473,
0.0637670809111911, 0.0635496462099423, 0.0691189475202549, 0.0655895846428505,
0.0901272136660486, 0.0932030302596897, 0.0658773090486944, 0.0622741730257009,
NA, NA, 0.0645216061829928, 0.0642238057477775, NA, NA, 0.0712812952630442,
0.0611932148522589, 0.0962115375352851, 0.0832177234363546, 0.0665058403359573,
0.060655916785088, NA, NA, NA, NA, NA, NA, NA, NA)), class = c("lavaan.data.frame",
"data.frame"), row.names = c(NA, -48L))

out2_ans <- structure(list(lhs = c("x1", "x1", "x1", "x2", "x2", "x3", "y1",
"y1", "y1", "y1", "y1", "y1", "y2", "y2", "y2", "y3", "y3", "y3"
), op = c("~~", "~~", "~~", "~~", "~~", "~~", "~", "~", "~",
"~~", "~~", "~~", "~", "~", "~~", "~", "~", "~~"), rhs = c("x1",
"x2", "x3", "x2", "x3", "x3", "x1", "x2", "x3", "y1", "y2", "y3",
"x1", "x3", "y2", "x2", "y2", "y3"), std.all_model1 = c(1, 0.0566064303137418,
-0.108335859415708, 1, 0.0156849610977612, 1, 0.178082828106242,
0.253065887784314, 0.0968970995780501, 0.892722577471892, NA,
0.0325694430322288, 0.173841338269987, 0.14442507837137, 0.9543605732867,
0.149963567659217, 0.151104662505378, 0.954129668001511), std.all_model2 = c(1,
0.0566064303137418, -0.108335859415708, 1, 0.0156849610977612,
1, 0.178277945418202, 0.253099552509797, 0.0968021105767493,
0.892649214152462, -0.0146519632160253, NA, NA, 0.125591895330581,
0.984226675827273, NA, NA, NA), se_model1 = c(0, 0, 0, 0, 0,
0, 0.0446218331117685, 0.045019870490342, 0.0476250512780367,
0.0653585469825251, NA, 0.0459122194164378, 0.0431960132059584,
0.0461718541280522, 0.0613966354344484, 0.0446216530000076, 0.0447375984748677,
0.0644352829232397), se_model2 = c(0, 0, 0, 0, 0, 0, 0.0446400126238595,
0.0450151135185147, 0.0476497383719982, 0.0653585214314532, 0.0454931684642695,
NA, NA, 0.0466127615495595, 0.0633179612723688, NA, NA, NA)), class = c("lavaan.data.frame",
"data.frame"), row.names = c(NA, -18L))

out3_ans <- structure(list(group = c(1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L,
1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 1L, 2L,
2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L, 2L,
2L, 2L, 2L, 2L, 2L, 2L, 2L), lhs = c("x1", "x1", "x1", "x1",
"x2", "x2", "x2", "x3", "x3", "y1", "y1", "y1", "y1", "y1", "y1",
"y1", "y2", "y2", "y2", "y2", "y3", "y3", "y3", "y3", "x1", "x1",
"x1", "x1", "x2", "x2", "x2", "x3", "x3", "y1", "y1", "y1", "y1",
"y1", "y1", "y1", "y2", "y2", "y2", "y2", "y3", "y3", "y3", "y3"
), op = c("~~", "~~", "~~", "~1", "~~", "~~", "~1", "~~", "~1",
"~", "~", "~", "~~", "~~", "~~", "~1", "~", "~", "~~", "~1",
"~", "~", "~~", "~1", "~~", "~~", "~~", "~1", "~~", "~~", "~1",
"~~", "~1", "~", "~", "~", "~~", "~~", "~~", "~1", "~", "~",
"~~", "~1", "~", "~", "~~", "~1"), rhs = c("x1", "x2", "x3",
"", "x2", "x3", "", "x3", "", "x1", "x2", "x3", "y1", "y2", "y3",
"", "x1", "x3", "y2", "", "x2", "y2", "y3", "", "x1", "x2", "x3",
"", "x2", "x3", "", "x3", "", "x1", "x2", "x3", "y1", "y2", "y3",
"", "x1", "x3", "y2", "", "x2", "y2", "y3", ""), std.all_model1 = c(1,
-0.0286771526679605, -0.0581722166132858, 0.00862364637919955,
1, 0.0198176588104157, 0.0693368324094334, 1, 0.096384217898341,
0.230492922043281, 0.22971760322925, 0.0365081047042141, 0.896453424198396,
NA, 0.0619941459427536, -0.003305548661855, 0.180210836596298,
0.123732579461709, 0.954808545700896, -0.025113096993796, 0.175874483409397,
0.126720664275303, 0.953131094972272, 0.0509135539766324, 1,
0.137522361597239, -0.154925828907883, -0.039559417557601, 1,
0.0118189225118024, 0.0121959864980669, 1, 0.0789029027439272,
0.131743104564718, 0.281669517496872, 0.143563375935194, 0.877393751228805,
NA, 0.013141235016658, 0.0373109621067823, 0.170598540011481,
0.164386659122635, 0.952562682775377, 0.0591907856082862, 0.124226195889164,
0.178283504870627, 0.951657575463657, -0.0156340962169415), std.all_model2 = c(1,
-0.0286771526679605, -0.0581722166132858, 0.00862364637919955,
1, 0.0198176588104157, 0.0693368324094334, 1, 0.096384217898341,
0.22902200957256, 0.230964781766562, 0.0366989610879774, 0.896533093586447,
-0.031053516708846, NA, -0.00339674162590084, NA, 0.113249175701435,
0.987174624202946, -0.0225484249101459, NA, NA, NA, NA, 1, 0.137522361597239,
-0.154925828907883, -0.039559417557601, 1, 0.0118189225118024,
0.0121959864980669, 1, 0.0789029027439272, 0.131555004152025,
0.281700204687996, 0.143371071377257, 0.877479600589609, -0.000402491194641735,
NA, 0.0373206393725567, NA, 0.137956716206957, 0.980967944453393,
0.0545274245502585, NA, NA, NA, NA), se_model1 = c(0, 0, 0, 0,
0, 0, 0, 0, 0, 0.0610241167164606, 0.0637983036178297, 0.0689887873389489,
0.0901288945902144, NA, 0.0675160533067203, 0.0645212422274359,
0.0620995150697461, 0.0702219414390783, 0.0930570983450699, 0.0654130913523689,
0.0674196095926791, 0.0653785207427726, 0.100766026264319, 0.067914883927668,
0, 0, 0, 0, 0, 0, 0, 0, 0, 0.0652527419284262, 0.0635495488518365,
0.0655840745092829, 0.0932030419008193, NA, 0.0617721656583714,
0.0642237709911687, 0.0601565242221361, 0.0610377044710866, 0.080808044516427,
0.0597940141819917, 0.0589791519949433, 0.0610561370589951, 0.0818673195136828,
0.0601068338669732), se_model2 = c(0, 0, 0, 0, 0, 0, 0, 0, 0,
0.061107866578356, 0.0637670809111911, 0.0691189475202549, 0.0901272136660486,
0.0658773090486944, NA, 0.0645216061829928, NA, 0.0712812952630442,
0.0962115375352851, 0.0665058403359573, NA, NA, NA, NA, 0, 0,
0, 0, 0, 0, 0, 0, 0, 0.0652582106369473, 0.0635496462099423,
0.0655895846428505, 0.0932030302596897, 0.0622741730257009, NA,
0.0642238057477775, NA, 0.0611932148522589, 0.0832177234363546,
0.060655916785088, NA, NA, NA, NA)), class = c("lavaan.data.frame",
"data.frame"), row.names = c(NA, -48L))

test_that("Test against know results", {
    expect_true(all.equal(out1[order(out1$op, out1$lhs, out1$rhs, out1$group), ],
                 out1_ans[order(out1_ans$op, out1_ans$lhs, out1_ans$rhs, out1_ans$group), ],
                 check.attributes = FALSE))
    expect_true(all.equal(out2[order(out2$op, out2$lhs, out2$rhs), ],
                 out2_ans[order(out2_ans$op, out2_ans$lhs, out2_ans$rhs), ],
                 check.attributes = FALSE))
    expect_true(all.equal(out3[order(out3$op, out3$lhs, out3$rhs, out3$group), ],
                 out3_ans[order(out3_ans$op, out3_ans$lhs, out3_ans$rhs, out3_ans$group), ],
                 check.attributes = FALSE))
  })

test_that("Results from different outputs", {
    expect_true(identical(out1est[order(out1est$op, out1est$lhs, out1est$rhs, out1est$group), ],
                          out1est_est[order(out1est_est$op, out1est_est$lhs, out1est_est$rhs, out1est_est$group), ]))
    expect_true(identical(out1[common_names, "std.all"],
                          out1_std[common_names, "est.std"]))
  })
